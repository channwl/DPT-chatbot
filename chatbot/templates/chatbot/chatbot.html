{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>디지털경영전공 챗봇</title>
    <link rel="stylesheet" href="{% static 'chatbot/style.css' %}">
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <header>
            <div class="header-flex">
                <img src="{% static 'chatbot/diget_logo.png' %}" alt="Diget 로고" class="logo">
            </div>
        </header>

        <!-- 인트로 영역 -->
        <div class="intro-box">
            <img src="{% static 'chatbot/korea_tiger_icon.gif' %}" alt="챗봇 아이콘">
            <div class="intro-text">
                <p>안녕하세요 😊 디지털경영전공 챗봇입니다!<br>
                아래 카테고리에서 원하는 주제를 선택하거나 질문해보세요 👇</p>
            </div>
        </div>

        <!-- 카테고리 박스 -->
        <div class="category-box">
            <div class="category-card">
                <div class="category-title">📅 학사일정</div>
                <div class="category-content">
                    <button onclick="addBotMessage('학사일정')">학사일정 확인</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">🧾 학적</div>
                <div class="category-content">
                    <button onclick="addBotMessage('학적')">학적 관련 정보</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">💰 장학</div>
                <div class="category-content">
                    <button onclick="addBotMessage('장학')">장학 안내</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">🎯 비교과</div>
                <div class="category-content">
                    <button onclick="addBotMessage('비교과')">비교과 프로그램</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">🏢 조직도</div>
                <div class="category-content">
                    <button onclick="addBotMessage('조직도')">조직도 보기</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">🎓 진로</div>
                <div class="category-content">
                    <button onclick="addBotMessage('진로')">진로 탐색</button>
                </div>
            </div>
        </div>

        <!-- 채팅 히스토리 -->
        <div id="chat-history"></div>

        <!-- 질문 입력 폼 -->
        <form id="chat-form" method="post">
            {% csrf_token %}
            <textarea name="question" placeholder="궁금한 점을 입력하세요..." required></textarea>
            <button type="submit">보내기 ➤</button>
        </form>
    </div>

    <script>
        const staticTigerIcon = "{% static 'chatbot/diget_logo_small.png' %}";

        function formatBotResponse(text) {
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\\n/g, '\n');

            const lines = formatted.split('\n');
            let result = "";
            let insideList = false;

            for (let line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                if (trimmed.startsWith("- ") || trimmed.startsWith("• ")) {
                    if (!insideList) {
                        result += "<ul>";
                        insideList = true;
                    }
                    result += `<li>${trimmed.slice(2).trim()}</li>`;
                } else {
                    if (insideList) {
                        result += "</ul>";
                        insideList = false;
                    }
                    result += `<p>${trimmed}</p>`;
                }
            }
            if (insideList) result += "</ul>";
            return result;
        }

        function addBotMessage(category) {
            const chatHistory = document.getElementById('chat-history');
            const botMessage = document.createElement('div');
            botMessage.classList.add('message', 'bot');

            let content = "";

            switch (category) {
                case "학사일정":
                    content = `
<h3>📅 학사일정 안내</h3>
<ul>
    <li>📝 <strong>5/14~16</strong>: 이중전공 신청</li>
    <li>📘 <strong>5/26</strong>: 1학기 3/4 시점</li>
    <li>📝 <strong>6/17~23</strong>: 기말고사</li>
    <li>🎉 <strong>6/23</strong>: 종강</li>
</ul>`;
                    break;
                case "학적":
                    content = `
<h3>🧾 학적 안내</h3>
<ul>
    <li><strong>이수학점</strong>: 130학점 이상</li>
    <li><strong>전공필수</strong>: 6과목 이상</li>
</ul>`;
                    break;
                default:
                    content = `🤖 ${category}에 대한 안내는 준비 중입니다.`;
            }

            botMessage.innerHTML = `<img src="${staticTigerIcon}" class="bot-icon"> ${content}`;
            chatHistory.appendChild(botMessage);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('chat-form');
            const chatHistory = document.getElementById('chat-history');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const textarea = form.querySelector('textarea');
                const userInput = textarea.value.trim();

                if (userInput) {
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user');
                    userMessage.innerText = '👨‍🎓 ' + userInput;
                    chatHistory.appendChild(userMessage);

                    const loadingMessage = document.createElement('div');
                    loadingMessage.classList.add('message', 'bot', 'loading');
                    loadingMessage.innerHTML = `<img src="${staticTigerIcon}" class="loading-icon"> 답변을 준비하고 있어요...`;
                    chatHistory.appendChild(loadingMessage);
                    chatHistory.scrollTop = chatHistory.scrollHeight;

                    fetch("{% url 'chatbot:chatbot_ask' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: "question=" + encodeURIComponent(userInput)
                    })
                    .then(response => response.json())
                    .then(data => {
                        loadingMessage.remove();
                        const botMessage = document.createElement('div');
                        botMessage.classList.add('message', 'bot');
                        const formatted = formatBotResponse(data.response);
                        botMessage.innerHTML = `<img src="${staticTigerIcon}" class="bot-icon"> ` + formatted;
                        chatHistory.appendChild(botMessage);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    })
                    .catch(error => {
                        console.error('오류 발생:', error);
                        loadingMessage.remove();
                        const errorMessage = document.createElement('div');
                        errorMessage.classList.add('message', 'bot');
                        errorMessage.innerText = '⚠️ 오류가 발생했습니다. 다시 시도해주세요.';
                        chatHistory.appendChild(errorMessage);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    });

                    textarea.value = '';
                }
            });
        });
    </script>
</body>
</html>
