{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë””ì§€í„¸ê²½ì˜ì „ê³µ ì±—ë´‡</title>
    <link rel="stylesheet" href="{% static 'chatbot/style.css' %}">
    <style>
        .header-flex {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-bottom: 2px solid #800000;
        }

        .logo {
            height: 50px;
            margin-right: 12px;
        }

        .header-title {
            font-size: 24px;
            color: #800000;
            font-weight: bold;
        }

        .intro-box {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            background-color: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .intro-box img {
            width: 100px;
            height: auto;
        }

        .intro-text {
            font-size: 16px;
            line-height: 1.6;
        }

        .message.bot, .message.user {
            white-space: pre-line !important;
        }

        .bot-icon {
            height: 35px;
            width: auto;
            vertical-align: middle;
            margin-right: 6px;
            border-radius: 4px;
        }

        #chat-form button {
            background-color: #800000;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header>
            <div class="header-flex">
                <img src="{% static 'chatbot/diget_logo.png' %}" alt="Diget ë¡œê³ " class="logo">
            </div>
        </header>

        <!-- ì¸íŠ¸ë¡œ ì˜ì—­ -->
        <div class="intro-box">
            <img src="{% static 'chatbot/korea_tiger_icon.gif' %}" alt="ì±—ë´‡ ì•„ì´ì½˜">
            <div class="intro-text">
                <p>ì•ˆë…•í•˜ì„¸ìš” ğŸ˜Š ë””ì§€í„¸ê²½ì˜ì „ê³µ ì±—ë´‡ì…ë‹ˆë‹¤!<br>
                ì•„ë˜ ì¹´í…Œê³ ë¦¬ì—ì„œ ì›í•˜ëŠ” ì£¼ì œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ˆë¬¸í•´ë³´ì„¸ìš” ğŸ‘‡</p>
            </div>
        </div>

        <!-- ì±„íŒ… íˆìŠ¤í† ë¦¬ -->
        <div id="chat-history"></div>

        <!-- ì§ˆë¬¸ ì…ë ¥ í¼ -->
        <form id="chat-form" method="post">
            {% csrf_token %}
            <textarea name="question" placeholder="ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
            <button type="submit">ë³´ë‚´ê¸° â¤</button>
        </form>
    </div>

    <script>
        const staticTigerIcon = "{% static 'chatbot/diget_logo_small.png' %}";

        function formatBotResponse(text) {
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\\n/g, '\n');
            const lines = formatted.split('\n');
            let result = "";
            let insideList = false;

            for (let line of lines) {
                const trimmed = line.trim();
                if (trimmed === "") continue;

                if (trimmed.startsWith("- ") || trimmed.startsWith("\u2022 ")) {
                    if (!insideList) {
                        result += "<ul>";
                        insideList = true;
                    }
                    result += `<li>${trimmed.slice(2).trim()}</li>`;
                } else {
                    if (insideList) {
                        result += "</ul>";
                        insideList = false;
                    }
                    result += `<p>${trimmed}</p>`;
                }
            }
            if (insideList) result += "</ul>";
            return result;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('chat-form');
            const chatHistory = document.getElementById('chat-history');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const textarea = form.querySelector('textarea');
                const userInput = textarea.value.trim();

                if (userInput) {
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user');
                    userMessage.innerText = 'ğŸ‘¨â€ğŸ“ ' + userInput;
                    chatHistory.appendChild(userMessage);

                    const loadingMessage = document.createElement('div');
                    loadingMessage.classList.add('message', 'bot', 'loading');
                    loadingMessage.innerHTML = `<img src="${staticTigerIcon}" class="loading-icon"> ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...`;
                    chatHistory.appendChild(loadingMessage);
                    chatHistory.scrollTop = chatHistory.scrollHeight;

                    fetch("{% url 'chatbot:chatbot_ask' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: "question=" + encodeURIComponent(userInput)
                    })
                    .then(response => response.json())
                    .then(data => {
                        loadingMessage.remove();
                        const botMessage = document.createElement('div');
                        botMessage.classList.add('message', 'bot');
                        const formatted = formatBotResponse(data.response);
                        botMessage.innerHTML = `<img src="${staticTigerIcon}" class="bot-icon"> ` + formatted;
                        chatHistory.appendChild(botMessage);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    })
                    .catch(error => {
                        console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
                        loadingMessage.remove();
                        const errorMessage = document.createElement('div');
                        errorMessage.classList.add('message', 'bot');
                        errorMessage.innerText = 'âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                        chatHistory.appendChild(errorMessage);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    });

                    textarea.value = '';
                }
            });
        });
    </script>
</body>
</html>
