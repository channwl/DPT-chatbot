{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë””ì§€í„¸ê²½ì˜ì „ê³µ ì±—ë´‡</title>
    <link rel="stylesheet" href="{% static 'chatbot/style.css' %}">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header>
            <div class="header-flex">
                <img src="{% static 'chatbot/diget_logo.png' %}" alt="Diget ë¡œê³ " class="logo">
            </div>
        </header>

        <!-- ì¸íŠ¸ë¡œ ì˜ì—­ -->
        <div class="intro-box">
            <img src="{% static 'chatbot/korea_tiger_icon.gif' %}" alt="ì±—ë´‡ ì•„ì´ì½˜">
            <div class="intro-text">
                <p>ì•ˆë…•í•˜ì„¸ìš” ğŸ˜Š ë””ì§€í„¸ê²½ì˜ì „ê³µ ì±—ë´‡ì…ë‹ˆë‹¤!<br>
                ì•„ë˜ ì¹´í…Œê³ ë¦¬ì—ì„œ ì›í•˜ëŠ” ì£¼ì œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ˆë¬¸í•´ë³´ì„¸ìš” ğŸ‘‡</p>
            </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ë°•ìŠ¤ -->
        <div class="category-box">
            <div class="category-card">
                <div class="category-title">ğŸ“… í•™ì‚¬ì¼ì •</div>
                <div class="category-content">
                    <button onclick="addBotMessage('í•™ì‚¬ì¼ì •')">í•™ì‚¬ì¼ì • í™•ì¸</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">ğŸ§¾ í•™ì </div>
                <div class="category-content">
                    <button onclick="addBotMessage('í•™ì ')">í•™ì  ê´€ë ¨ ì •ë³´</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">ğŸ’° ì¥í•™</div>
                <div class="category-content">
                    <button onclick="addBotMessage('ì¥í•™')">ì¥í•™ ì•ˆë‚´</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">ğŸ¯ ë¹„êµê³¼</div>
                <div class="category-content">
                    <button onclick="addBotMessage('ë¹„êµê³¼')">ë¹„êµê³¼ í”„ë¡œê·¸ë¨</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">ğŸ¢ ì¡°ì§ë„</div>
                <div class="category-content">
                    <button onclick="addBotMessage('ì¡°ì§ë„')">ì¡°ì§ë„ ë³´ê¸°</button>
                </div>
            </div>
            <div class="category-card">
                <div class="category-title">ğŸ“ ì§„ë¡œ</div>
                <div class="category-content">
                    <button onclick="addBotMessage('ì§„ë¡œ')">ì§„ë¡œ íƒìƒ‰</button>
                </div>
            </div>
        </div>

        <!-- ì±„íŒ… íˆìŠ¤í† ë¦¬ -->
        <div id="chat-history"></div>

        <!-- ì§ˆë¬¸ ì…ë ¥ í¼ -->
        <form id="chat-form" method="post">
            {% csrf_token %}
            <textarea name="question" placeholder="ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
            <button type="submit">ë³´ë‚´ê¸° â¤</button>
        </form>
    </div>

    <script>
        const staticTigerIcon = "{% static 'chatbot/diget_logo_small.png' %}";

        function formatBotResponse(text) {
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\\n/g, '\n');

            const lines = formatted.split('\n');
            let result = "";
            let insideList = false;

            for (let line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                if (trimmed.startsWith("- ") || trimmed.startsWith("â€¢ ")) {
                    if (!insideList) {
                        result += "<ul>";
                        insideList = true;
                    }
                    result += `<li>${trimmed.slice(2).trim()}</li>`;
                } else {
                    if (insideList) {
                        result += "</ul>";
                        insideList = false;
                    }
                    result += `<p>${trimmed}</p>`;
                }
            }
            if (insideList) result += "</ul>";
            return result;
        }

        function addBotMessage(category) {
            const chatHistory = document.getElementById('chat-history');
            const botMessage = document.createElement('div');
            botMessage.classList.add('message', 'bot');

            let content = "";

            switch (category) {
                case "í•™ì‚¬ì¼ì •":
                    content = `
<h3>ğŸ“… í•™ì‚¬ì¼ì • ì•ˆë‚´</h3>
<ul>
    <li>ğŸ“ <strong>5/14~16</strong>: ì´ì¤‘ì „ê³µ ì‹ ì²­</li>
    <li>ğŸ“˜ <strong>5/26</strong>: 1í•™ê¸° 3/4 ì‹œì </li>
    <li>ğŸ“ <strong>6/17~23</strong>: ê¸°ë§ê³ ì‚¬</li>
    <li>ğŸ‰ <strong>6/23</strong>: ì¢…ê°•</li>
</ul>`;
                    break;
                case "í•™ì ":
                    content = `
<h3>ğŸ§¾ í•™ì  ì•ˆë‚´</h3>
<ul>
    <li><strong>ì´ìˆ˜í•™ì </strong>: 130í•™ì  ì´ìƒ</li>
    <li><strong>ì „ê³µí•„ìˆ˜</strong>: 6ê³¼ëª© ì´ìƒ</li>
</ul>`;
                    break;
                default:
                    content = `ğŸ¤– ${category}ì— ëŒ€í•œ ì•ˆë‚´ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.`;
            }

            botMessage.innerHTML = `<img src="${staticTigerIcon}" class="bot-icon"> ${content}`;
            chatHistory.appendChild(botMessage);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('chat-form');
            const chatHistory = document.getElementById('chat-history');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const textarea = form.querySelector('textarea');
                const userInput = textarea.value.trim();

                if (userInput) {
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user');
                    userMessage.innerText = 'ğŸ‘¨â€ğŸ“ ' + userInput;
                    chatHistory.appendChild(userMessage);

                    const loadingMessage = document.createElement('div');
                    loadingMessage.classList.add('message', 'bot', 'loading');
                    loadingMessage.innerHTML = `<img src="${staticTigerIcon}" class="loading-icon"> ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...`;
                    chatHistory.appendChild(loadingMessage);
                    chatHistory.scrollTop = chatHistory.scrollHeight;

                    fetch("{% url 'chatbot:chatbot_ask' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: "question=" + encodeURIComponent(userInput)
                    })
                    .then(response => response.json())
                    .then(data => {
                        loadingMessage.remove();
                        const botMessage = document.createElement('div');
                        botMessage.classList.add('message', 'bot');
                        const formatted = formatBotResponse(data.response);
                        botMessage.innerHTML = `<img src="${staticTigerIcon}" class="bot-icon"> ` + formatted;
                        chatHistory.appendChild(botMessage);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    })
                    .catch(error => {
                        console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
                        loadingMessage.remove();
                        const errorMessage = document.createElement('div');
                        errorMessage.classList.add('message', 'bot');
                        errorMessage.innerText = 'âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                        chatHistory.appendChild(errorMessage);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    });

                    textarea.value = '';
                }
            });
        });
    </script>
</body>
</html>
