{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>디지털경영전공 챗봇</title>
    <link rel="stylesheet" href="{% static 'chatbot/style.css' %}">
    <style>
        .header-flex {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-bottom: 2px solid #800000;
        }

        .logo {
            height: 50px;
            margin-right: 12px;
        }

        .header-title {
            font-size: 24px;
            color: #800000;
            font-weight: bold;
        }

        .intro-box {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            background-color: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .intro-box img {
            width: 100px;
            height: auto;
        }

        .intro-text {
            font-size: 16px;
            line-height: 1.6;
        }

        .message.bot, .message.user {
            white-space: pre-line !important;
        }

        .bot-icon {
            height: 35px;
            width: auto;
            vertical-align: middle;
            margin-right: 6px;
            border-radius: 4px;
        }

        #chat-form button {
            background-color: #800000;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <header>
            <div class="header-flex">
                <img src="{% static 'chatbot/diget_logo.png' %}" alt="Diget 로고" class="logo">
            </div>
        </header>

        <!-- 인트로 영역 -->
        <div class="intro-box">
            <img src="{% static 'chatbot/korea_tiger_icon.gif' %}" alt="챗봇 아이콘">
            <div class="intro-text">
                <p>안녕하세요 😊 디지털경영전공 챗봇입니다!<br>
                아래 카테고리에서 원하는 주제를 선택하거나 질문해보세요 👇</p>
            </div>
        </div>

        <!-- 채팅 히스토리 -->
        <div id="chat-history"></div>

        <!-- 질문 입력 폼 -->
        <form id="chat-form" method="post">
            {% csrf_token %}
            <textarea name="question" placeholder="궁금한 점을 입력하세요..." required></textarea>
            <button type="submit">보내기 ➤</button>
        </form>
    </div>

    <script>
        const staticTigerIcon = "{% static 'chatbot/diget_logo_small.png' %}";

        function formatBotResponse(text) {
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\\n/g, '\n');
            const lines = formatted.split('\n');
            let result = "";
            let insideList = false;

            for (let line of lines) {
                const trimmed = line.trim();
                if (trimmed === "") continue;

                if (trimmed.startsWith("- ") || trimmed.startsWith("\u2022 ")) {
                    if (!insideList) {
                        result += "<ul>";
                        insideList = true;
                    }
                    result += `<li>${trimmed.slice(2).trim()}</li>`;
                } else {
                    if (insideList) {
                        result += "</ul>";
                        insideList = false;
                    }
                    result += `<p>${trimmed}</p>`;
                }
            }
            if (insideList) result += "</ul>";
            return result;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('chat-form');
            const chatHistory = document.getElementById('chat-history');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const textarea = form.querySelector('textarea');
                const userInput = textarea.value.trim();

                if (userInput) {
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user');
                    userMessage.innerText = '👨‍🎓 ' + userInput;
                    chatHistory.appendChild(userMessage);

                    const loadingMessage = document.createElement('div');
                    loadingMessage.classList.add('message', 'bot', 'loading');
                    loadingMessage.innerHTML = `<img src="${staticTigerIcon}" class="loading-icon"> 답변을 준비하고 있어요...`;
                    chatHistory.appendChild(loadingMessage);
                    chatHistory.scrollTop = chatHistory.scrollHeight;

                    fetch("{% url 'chatbot:chatbot_ask' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: "question=" + encodeURIComponent(userInput)
                    })
                    .then(response => response.json())
                    .then(data => {
                        loadingMessage.remove();
                        const botMessage = document.createElement('div');
                        botMessage.classList.add('message', 'bot');
                        const formatted = formatBotResponse(data.response);
                        botMessage.innerHTML = `<img src="${staticTigerIcon}" class="bot-icon"> ` + formatted;
                        chatHistory.appendChild(botMessage);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    })
                    .catch(error => {
                        console.error('오류 발생:', error);
                        loadingMessage.remove();
                        const errorMessage = document.createElement('div');
                        errorMessage.classList.add('message', 'bot');
                        errorMessage.innerText = '⚠️ 오류가 발생했습니다. 다시 시도해주세요.';
                        chatHistory.appendChild(errorMessage);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    });

                    textarea.value = '';
                }
            });
        });
    </script>
</body>
</html>
